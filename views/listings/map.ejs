<% layout("layouts/boilerplate") -%>
<div class="row">
  <div class="col-12">
    <h1 class="mb-4">Location: <%= listing.title %></h1>
    
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><%= listing.location %>, <%= listing.country %></h5>
        <p class="card-text"><%= listing.description %></p>
        
        <div id="map" style="height: 400px; width: 100%;" class="mb-3"></div>
        
        <a href="/listings/<%= listing._id %>" class="btn btn-primary">Back to Listing</a>
      </div>
    </div>
  </div>
</div>



<script>
document.addEventListener("DOMContentLoaded", async function () {
  // Convert the listing object into a usable JS object
  const listing = <%- JSON.stringify(listing) %>;
  const mapContainer = document.getElementById("map");

  // If there is no location in the listing, show a message
  if (!listing.location) {
    mapContainer.innerHTML = "<p class='text-danger'>No location found.</p>";
    return;
  }

  try {
    // Fetch coordinates using Nominatim API
    const response = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(listing.location)}`
    );
    const data = await response.json();

    if (data.length === 0) {
      mapContainer.innerHTML = "<p class='text-danger'>Unable to find location on map.</p>";
      return;
    }

    // Extract latitude and longitude
    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);

    // Initialize map with coordinates
    const map = L.map("map").setView([lat, lon], 13);

    // Add OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);

    // Add marker on the location
    L.marker([lat, lon])
      .addTo(map)
      .bindPopup(`<b>${listing.title}</b><br>${listing.location}`)
      .openPopup();

  } catch (error) {
    console.error("Map error:", error);
    mapContainer.innerHTML = "<p class='text-danger'>Error loading map.</p>";
  }
});
</script>
